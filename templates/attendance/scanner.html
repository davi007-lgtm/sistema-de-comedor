{% extends "base.html" %}

{% block title %}Escáner QR - Sistema de Cafetería{% endblock %}

{% block styles %}
<style>
    #reader {
        width: 100%;
        max-width: 640px;
        margin: 0 auto;
    }
    .scanner-container {
        position: relative;
        overflow: hidden;
        border-radius: 10px;
    }
    .camera-error {
        text-align: center;
        padding: 2rem;
        background: rgba(0, 0, 0, 0.05);
        border-radius: 10px;
    }
    .success-scan {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(25, 135, 84, 0.9);
        color: white;
        padding: 1rem 2rem;
        border-radius: 10px;
        display: none;
        z-index: 1000;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-qrcode me-2"></i>Escáner QR
                    </h5>
                    <div>
                        <button id="startCamera" class="btn btn-success btn-sm">
                            <i class="fas fa-play me-2"></i>Iniciar Cámara
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="scanner-container mb-3">
                        <div id="reader"></div>
                    </div>
                    <div class="camera-error d-none">
                        <i class="fas fa-exclamation-triangle text-warning fa-2x mb-3"></i>
                        <h5>No se pudo acceder a la cámara</h5>
                        <p class="text-muted">Por favor, asegúrate de que:</p>
                        <ul class="text-start text-muted">
                            <li>Has dado permiso para usar la cámara</li>
                            <li>Tu dispositivo tiene una cámara funcionando</li>
                            <li>Ninguna otra aplicación está usando la cámara</li>
                        </ul>
                        <button class="btn btn-primary mt-3" onclick="initScanner()">
                            <i class="fas fa-redo me-2"></i>Reintentar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Últimas asistencias registradas -->
            <div class="card shadow-sm mt-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>Últimos Registros
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Hora</th>
                                    <th>Estudiante</th>
                                    <th>Curso</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="registrosRecientes">
                                <!-- Los registros se agregarán dinámicamente aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notificación de escaneo exitoso -->
<div id="successNotification" class="success-scan">
    <i class="fas fa-check-circle me-2"></i>
    <span id="successMessage"></span>
</div>
{% endblock %}

{% block scripts %}
<!-- HTML5 QR Code Scanner -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
let html5QrcodeScanner = null;

function onScanSuccess(decodedText, decodedResult) {
    handleQRCode(decodedText);
}

function onScanFailure(error) {
    // Manejar errores silenciosamente
    console.warn(`Código QR no detectado: ${error}`);
}

async function initScanner() {
    try {
        // Ocultar mensaje de error si está visible
        document.querySelector('.camera-error').classList.add('d-none');
        
        if (html5QrcodeScanner) {
            await html5QrcodeScanner.clear();
        }

        html5QrcodeScanner = new Html5QrcodeScanner(
            "reader", 
            { 
                fps: 10,
                qrbox: {width: 250, height: 250},
                aspectRatio: 1.0,
                showTorchButtonIfSupported: true,
                showZoomSliderIfSupported: true,
                defaultZoomValueIfSupported: 2
            }
        );
        
        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        
        console.log('Scanner iniciado con éxito');
    } catch (e) {
        console.error('Error al inicializar el scanner:', e);
        showCameraError();
    }
}

function showCameraError() {
    document.querySelector('.camera-error').classList.remove('d-none');
}

async function handleQRCode(content) {
    try {
        const response = await fetch('{{ url_for("attendance.api_registrar_asistencia") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                estudiante_id: content,
                tipo: 'almuerzo'
            })
        });

        const data = await response.json();
        
        if (data.success) {
            showSuccess(data.message);
            updateRegistrosRecientes(data);
        } else {
            showError(data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        showError('Error al procesar el código QR');
    }
}

function showSuccess(message) {
    const notification = document.getElementById('successNotification');
    const messageElement = document.getElementById('successMessage');
    messageElement.textContent = message;
    notification.style.display = 'block';
    
    // Ocultar después de 3 segundos
    setTimeout(() => {
        notification.style.display = 'none';
    }, 3000);
}

function showError(message) {
    // Usar el sistema de alertas de Bootstrap
    const alertHtml = `
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    document.querySelector('.card-body').insertAdjacentHTML('afterbegin', alertHtml);
}

function updateRegistrosRecientes(data) {
    const tbody = document.getElementById('registrosRecientes');
    const row = document.createElement('tr');
    const now = new Date();
    
    row.innerHTML = `
        <td>${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}</td>
        <td>${data.estudiante_nombre}</td>
        <td>${data.curso || '-'}</td>
        <td><span class="badge bg-success">Registrado</span></td>
    `;
    
    tbody.insertBefore(row, tbody.firstChild);
    
    // Mantener solo los últimos 10 registros
    while (tbody.children.length > 10) {
        tbody.removeChild(tbody.lastChild);
    }
}

// Botón para iniciar la cámara
document.getElementById('startCamera').addEventListener('click', initScanner);

// Mostrar mensaje inicial
document.addEventListener('DOMContentLoaded', () => {
    console.log('Página cargada, esperando clic para iniciar cámara');
});
</script>
{% endblock %} 