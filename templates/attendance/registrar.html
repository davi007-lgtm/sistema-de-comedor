{% extends "base.html" %}

{% block title %}Registrar Asistencia - Sistema de Cafetería{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/attendance.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid mt-4 attendance-container">
    <!-- Header con estadísticas rápidas -->
    <div class="row mb-4 fade-in">
        <div class="col-12">
            <h1 class="text-2xl font-bold text-primary mb-2">
                <i class="fas fa-user-check me-2"></i>Registro de Asistencias
            </h1>
            <p class="text-dark-text-muted">Gestione el registro de asistencias de estudiantes a la cafetería</p>
        </div>
    </div>

    <div class="row">
        <!-- Panel izquierdo: Búsqueda y Registro -->
        <div class="col-xl-4 col-lg-5">
            <!-- Tarjeta de búsqueda -->
            <div class="card shadow-lg slide-in">
                <div class="card-header">
                    <h6 class="m-0 font-semibold">
                        <i class="fas fa-search me-2"></i>Buscar Estudiante
                    </h6>
                </div>
                <div class="card-body">
                    <form id="searchForm" class="search-form-container">
                        <div class="mb-3">
                            <label for="searchType" class="form-label">Buscar por:</label>
                            <select class="form-select" id="searchType" name="searchType">
                                <option value="identificador">Identificador</option>
                                <option value="nombre">Nombre</option>
                                <option value="curso">Curso</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="searchValue" class="form-label">Valor:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="searchValue" name="searchValue" 
                                       placeholder="Ingrese el valor a buscar...">
                                <button class="btn btn-primary" type="submit">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tarjeta de registro manual -->
            <div class="card shadow-lg mt-4 slide-in" style="animation-delay: 0.1s;">
                <div class="card-header">
                    <h6 class="m-0 font-semibold">
                        <i class="fas fa-edit me-2"></i>Registro Manual
                    </h6>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('attendance.registrar_asistencia') }}">
                        <div class="mb-3">
                            <label for="identificador" class="form-label">Identificador:</label>
                            <input type="text" class="form-control" id="identificador" name="identificador" required 
                                   placeholder="Ingrese el identificador del estudiante...">
                        </div>
                        <div class="mb-3">
                            <label for="tipo" class="form-label">Tipo de Comida:</label>
                            <select class="form-select" id="tipo" name="tipo" required>
                                <option value="desayuno">Desayuno</option>
                                <option value="almuerzo" selected>Almuerzo</option>
                                <option value="cena">Cena</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="observaciones" class="form-label">Observaciones:</label>
                            <textarea class="form-control" id="observaciones" name="observaciones" rows="2"
                                    placeholder="Agregue observaciones si es necesario..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-success w-100">
                            <i class="fas fa-check me-2"></i>Registrar Asistencia
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Panel derecho: Resultados y últimas asistencias -->
        <div class="col-xl-8 col-lg-7">
            <!-- Tarjeta de resultados de búsqueda -->
            <div class="card shadow-lg slide-in" style="animation-delay: 0.2s;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-semibold">
                        <i class="fas fa-list me-2"></i>Resultados de Búsqueda
                    </h6>
                    <span class="badge bg-primary" id="resultCount">0 resultados</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Identificador</th>
                                    <th>Nombre</th>
                                    <th>Curso</th>
                                    <th>Tipo</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="searchResults">
                                <!-- Los resultados se cargarán dinámicamente aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tarjeta de últimas asistencias -->
            <div class="card shadow-lg mt-4 slide-in" style="animation-delay: 0.3s;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-semibold">
                        <i class="fas fa-clock me-2"></i>Últimas Asistencias Registradas
                    </h6>
                    <a href="{{ url_for('attendance.historial') }}" class="btn btn-sm btn-primary">
                        <i class="fas fa-history me-1"></i>Ver historial
                    </a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Hora</th>
                                    <th>Estudiante</th>
                                    <th>Curso</th>
                                    <th>Tipo</th>
                                    <th>Método</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for asistencia in ultimas_asistencias %}
                                <tr class="fade-in" style="animation-delay: {{ loop.index0 * 0.1 }}s">
                                    <td class="text-nowrap">{{ asistencia.hora.strftime('%H:%M') }}</td>
                                    <td>{{ asistencia.estudiante.nombre }}</td>
                                    <td>{{ asistencia.estudiante.curso }}</td>
                                    <td>
                                        <span class="badge bg-info">{{ asistencia.tipo|title }}</span>
                                    </td>
                                    <td>
                                        <span class="badge {% if asistencia.metodo_registro == 'manual' %}bg-primary{% else %}bg-secondary{% endif %}">
                                            {{ asistencia.metodo_registro|title }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchForm = document.getElementById('searchForm');
    const searchResults = document.getElementById('searchResults');
    const resultCount = document.getElementById('resultCount');

    searchForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = {
            tipo: formData.get('searchType'),
            valor: formData.get('searchValue')
        };
        
        try {
            const response = await fetch('{{ url_for("attendance.api_buscar_estudiante") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                resultCount.textContent = `${result.estudiantes.length} resultados`;
                searchResults.innerHTML = result.estudiantes.map(estudiante => `
                    <tr>
                        <td>${estudiante.identificador}</td>
                        <td>${estudiante.nombre}</td>
                        <td>${estudiante.curso}</td>
                        <td>
                            <span class="badge ${estudiante.tipo_estudiante === 'becado' ? 'bg-success' : 'bg-info'}">
                                ${estudiante.tipo_estudiante}
                            </span>
                        </td>
                        <td class="text-center">
                            <button onclick="registrarAsistencia('${estudiante.id}')" class="btn btn-success btn-sm">
                                <i class="fas fa-check"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                alert('Error en la búsqueda: ' + result.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al realizar la búsqueda');
        }
    });
});

async function registrarAsistencia(estudianteId) {
    try {
        const response = await fetch('{{ url_for("attendance.api_registrar_asistencia") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                estudiante_id: estudianteId,
                tipo: document.getElementById('tipo').value
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Asistencia registrada exitosamente');
            location.reload();
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al registrar la asistencia');
    }
}
</script>
{% endblock %} 